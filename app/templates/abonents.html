{% extends 'index.html' %}


{% block app_content %}    
    <h4><strong>Данные по абонентам {{ text }}</strong></h4>
    <div class="form-group row">
        <div class="col-xs-7">
            <table id="table_6" class="table table-bordered table-hover" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th style="font-size: 13px;">Лицевой счет</th>
                        <th style="font-size: 13px;">ФИО</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in data %}
                        <tr>
                            <td>{{ user['ЛС'] }}</td>
                            <td>{{ user['ФИО'] }}</td>
                            <td>{{ user['СостояниеЛС'] }}</td>
                            <td>{{ user['СостояниеПодключения'] }}</td>
                            <td>{{ user['ДатаОткрытияЗакрытия'] }}</td>
                            <td>{{ user['ДатаПодключенияОтключения'] }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="col-xs-5">
            <div data-spy="affix" style="width: 27%">
                <h4>Личные данные</h4>
                <div class="col-xs-12">                
                    <h5 id="passport"><br><br></h5>
                </div>            
                <!-- <h4>Взаиморасчеты</h4> -->
                <h4>Установленное оборудование</h4>
                <div class="col-xs-12">
                    <span id="sch" hidden>
                        <h5><strong>Счетчик</strong></h5>
                        <h5 id="equipment_sch">----</h5>
                    </span>
                    <span id="otp" hidden>
                        <h5><strong>Отопительное оборудование</strong></h5>
                        <h5 id="equipment_otp">----</h5>
                    </span>
                    <span id="pg" hidden>
                        <h5><strong>Плита газовая</strong></h5>
                        <h5 id="equipment_pg">----</h5>
                    </span>
                    <span id="otp_pv" hidden>
                        <h5><strong>Отопление + подогрев воды</strong></h5>
                        <h5 id="equipment_otp_pv">----</h5>
                    </span>
                    <span id="cgv" hidden>
                        <h5><strong>Центр. гор. водоснабжение</strong></h5>
                        <h5 id="equipment_cgv">----</h5>
                    </span>
                    <span id="vnp" hidden>
                        <h5><strong>Водонагревательные приборы</strong></h5>
                        <h5 id="equipment_vnp">----</h5>
                    </span>
                </div>
            </div>
            <!-- если счетчик то добавляем данные -->
        </div>        
    </div>    
{% endblock %}

{% block app_scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.12/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.12/js/dataTables.bootstrap.min.js"></script>
    
    <script>
        var table_6 = $('#table_6').DataTable({
            "processing": true,                        
            "columnDefs": [
                {
                    "targets": [ 2, 3, 4, 5 ],
                    "visible": false
                }
            ],
            "language": {
                'processing': "Подождите...",
                'search': "Поиск:",
                'lengthMenu': "Показать _MENU_ записей",
                'info': "с _START_ до _END_ из _TOTAL_ записей",
                'infoEmpty': "с 0 до 0 из 0 записей",
                'infoFiltered': "(отфильтровано из _MAX_ записей)",
                'infoPostFix': "",
                'loadingRecords': "Загрузка записей...",
                'zeroRecords': "Записи отсутствуют.",
                'emptyTable': "В таблице отсутствуют данные",
                'thousands': " ",
                "paginate": {
                    "first": "Первая",
                    "previous": "<",
                    "next": ">",
                    "last": "Последняя"
                },
                "aria": {
                    "sortAscending": ": активировать для сортировки столбца по возрастанию",
                    "sortDescending": ": активировать для сортировки столбца по убыванию"
                }
            },
            "bPaginate": true,
            "pagingType": "numbers",
            "bLengthChange": true,
            "bFilter": true,
            "bInfo": true,
            "bAutoWidth": true
        });

        $('#table_6 tbody').on('click', 'tr', function() {
            if ( $(this).hasClass('info') ) {
                $(this).removeClass('info');                
            }
            else {
                var                    
                    $sch            = $('#sch'),
                    $otp            = $('#otp'),
                    $pg             = $('#pg'),
                    $otp_pv         = $('#otp_pv'),
                    $cgv            = $('#cgv'),
                    $vnp            = $('#vnp'),                    
                    _row            = $('#table_6').dataTable().fnGetData($(this));
                    _db             = location.pathname.substring(10, 13),
                    _period_start   = location.pathname.substring(14, 24).replace('.2', '.4');                    
                
                table_6.$('tr.info').removeClass('info');
                $(this).addClass('info');
                
                $sch.prop('hidden', true);
                $otp.prop('hidden', true);
                $pg.prop('hidden', true);
                $otp_pv.prop('hidden', true);
                $cgv.prop('hidden', true);
                $vnp.prop('hidden', true);

                $.post("{{ url_for('main.get_data_abonent')}}", {data: _db, ls: this.firstElementChild.innerText, period_start: _period_start})
                    .done(function(response){                        
                        $('#passport').html((_row[2] == 'off' ? 'Дата закрытия: ' : 'Дата открытия: ')+_row[4]+'<br>'+(_row[3] == 'Отключен' ? 'Дата отключения: ' : 'Дата подключения: ')+_row[5]+'<br><br>'+response.ЛичныеДанные);
                        if (response.Счетчик != '') {
                            $sch.prop('hidden', false);
                            $('#equipment_sch').html(response.Счетчик);
                        }
                        if (response.ОтопительноеОборудование != '') {                            
                            $otp.prop('hidden', false);
                            $('#equipment_otp').html(response.ОтопительноеОборудование);
                        }
                        if (response.ПлитаГазовая != '') {                            
                            $pg.prop('hidden', false);
                            $('#equipment_pg').html(response.ПлитаГазовая);
                        }
                        if (response.ОтоплениеПодогрев != '') {                            
                            $otp_pv.prop('hidden', false);
                            $('#equipment_otp_pv').html(response.ОтоплениеПодогрев);
                        }
                        if (response.ЦентрГорВодоснабжение != '') {                            
                            $cgv.prop('hidden', false);
                            $('#equipment_cgv').html(response.ЦентрГорВодоснабжение);
                        }
                        if (response.ВодонагревательныеПриборы != '') {                            
                            $vnp.prop('hidden', false);
                            $('#equipment_vnp').html(response.ВодонагревательныеПриборы);
                        }                        
                    })
                    .fail(function(response){console.log(response)})
            }
        });

    </script>
{% endblock %}